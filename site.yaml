---
  - hosts: all
    gather_facts: yes
    become: yes
    tasks:
      - name: apt update
        apt:
          update_cache: yes

  - hosts: HAproxy
    become: yes
    remote_user: ubuntu
    tasks:
      - name: HAproxy Update
        apt:
          update_cache: yes

      - name: Install HAProxy
        apt:
           name: haproxy
           state: latest

      - name: Configure HAProxy
        template:
           src: haproxy.cfg.j2
           dest: /etc/haproxy/haproxy.cfg.j2

      - name: Restart HAproxy
        become: yes
        name: haproxy
        state: started

  - hosts: webservers
    remote_user: ubuntu
    become: yes
    tasks:

      - name: Webservers update
        apt:
          update-cache: yes

      - name: install python3
        apt:
          name: python3
          state: latest

      - name: install python3-pip
        apt:
          name: python3-pip
          state: latest

      - name: install Gunicorn
        apt:
          name: gunicorn

      - name: copy the flask app code to the servers
        copy:
           src:  app.py
           dest: /home/ubuntu/flask-app/venv/app.py
           mode: 0775

      - name: execute the flask-app deployment
        shell: gunicorn -w 2 -D -b 0.0.0.0:5000 app.py
        async: 500
        poll: 0
